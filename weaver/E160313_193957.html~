<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="../css/css_002.css">
<link rel="shortcut icon" href="../images/treegb_icon.ico">
<title>[cryptsetup]</title>
</head>

<body>

<div class="meta_1">
    <p class="meta_2">.command .cryptsetup</a>&nbsp; :: LUKS, dm-crypt.</p>
    <p class="meta_3">E160313_193957</p>
</div>


<div class="crd">

    <p class="pch"><a href="https://wiki.archlinux.org/index.php/Disk_encryption">Disk encryption.</a>&nbsp; __ Arch wiki.</p>
    
    <p class="pch"><a href="https://wiki.archlinux.org/index.php/Dm-crypt">[dm-crypt].</a> 是 kernel 內建的一些東西, [cryptsetup] 是使用者的 "應用程式"?</p>    

    <p class="pch">Decrypt.</p>
        <p>{{ [losetup] . { [/dev/loop/] &lt;loop-number&gt; } . &lt;luks-device&gt; }}.&nbsp; < (因為我不是直接加密整顆硬碟, 我是加密檔案 (見<a href="https://wiki.archlinux.org/index.php/Dm-crypt/Encrypting_a_non-root_file_system#Loop_device">這裡</a>), 所以要先用 [losetup] 去打開該 loop device.)<br>
        {{ [cryptsetup] . [luksOpen] . { [/dev/loop/] &lt;loop-number&gt; } . &lt;mapping-alias&gt; }}.<br>
        {{ [mount] . { [/dev/mapper/] &lt;mapping-alias&gt; } . &lt;mount-point&gt; }}.</p>
    
    <p class="pch">Encrypt.</p>
        <p>{{ [umount] . &lt;mount-point&gt; }}.<br>
        {{ [cryptsetup] . [luksClose] . &lt;mapping-alias&gt; }}.<br>
        {{ [losetup] . [-d] . { [/dev/loop/]  &lt;loop-number&gt; } }}.<br>
        結束後可以用 [losetup -a] 查是否 "loop device" 都已經卸掉了. 以上步驟如果有需要連續做的話，不要用 [;] ，用 [&&] ，比較保險，避免意外.</p>
    
    <p class="pch">[luksFormat].</p>
        <p>我覺得不太需要作其他額外設定，就 [ [cryptsetup] . [luksFormat] ] 就可以了.</p>
    
    <p class="pch">還沒 [luksOpen] 可以進行以下動作（就算 [luksOpen] 了，好像也可以）:</p>
        <p>&nbsp;{{<br>
        [luksAddKey]<br>
        [luksChangeKey]<br>
        [luksRemovekey]<br>
        [luksKillSlot]<br>
        &nbsp;}}</p>
        
        <p>其中，我覺得 [luksRemovekey] 和 [luksKillSlot] 好像差不多，用  [luksRemovekey] 就可以了.<br>
        但有一個差別是移除時，兩個都會問密碼，只是一個是問 { [要移除的 slot] 的密碼} ，一個是問 { [非要移除的 slot] 的密碼} .如果忘記某 slot 的密碼，只能用 [luksKillSlot] 移除忘記的密碼.</p>
    
    <p class="pch">[--key-slot].</p>
        <div class="crd">
        
             <p class="pch">Slot.</p>
                <p>一個 &lt;luks-device&gt; 可以有 8 個 (0~7) key slot. 設定幾個 slot 也就是設定幾組密碼.</p>
            
            <p class="pch">[luksAddKey].</p>
                <p>預設的 key slot 是從 0 開始，然後一直往上加，最多到 7. 不只 [luksAddKey] 而已，其他功能都是一樣的 (是不是往回減我不知道).</p>
        
            <p class="pch">-</p>
                <p>[--key-slot] 可以連同以下這些功能一起使用：<br>
                &nbsp;{{<br>
                [luksFormat] (例 : {{ [cryptsetup] . [--key-slot] . [2] (第三個 slot) . [luksFormat] . &lt;device-to-create-luks-file&gt; }}. )<br>
                [luksOpen]<br>
                [luksAddKey]<br>
                [luksChangeKey]<br>
                [luksRemovekey]<br>
                但是 [luksKillSlot] 比較特別，要這樣 {{ [cryptsetup] . [luksKillSlot] . &lt;luks-device&gt; . &lt;slot-want-to-kill&gt; }}<br>
                &nbsp;}}</p>
                
                <p id="E160313_213416">另外，[--key-slot] 的作用是來保證不會選錯到 key slot (系統自己判斷的吧)，但我不知道為什麼，[--key-slot] 不是絕對有用.<br>
                像我用 [luksRemoveKey] 時，即使有指定 key slot，還是會移掉我輸入 password 的那個 slot!<br>
                不過對 [luksChangeKey] 的話要指定 [--key-slot], 不然它不會覆寫原本的密碼只會新增到新的 slot (man page 寫的).</p>
                
                
                <p>而且我覺得不是每一種狀況都要指定 [--key-slot].<br>
                畢竟，以 [luksChangeKey] 為例子，他一定會先問你密碼，這就已經代表是哪一個 slot 要換密碼了啊.</p>
                
                
                <p>[--key-slot] 還有一個用途就是，當只記得已經存在的密碼，但忘記是對應到哪個 slot.<br>
                這時用 [--key-slot] 配合 [luksOpen]，可以慢慢嘗試錯誤找出來.</p>
                
                <p>當 [luksOpen] 時，可以指定某 slot.
                (一組 slot 和一組密碼是綁在一起的（在 [luksAddKey] 時就已經固定了），不知道哪個 slot 是哪個密碼的話就會不能 decrypt).
                這個用法可以用來測試某個 slot 對應到的密碼是不是跟自己所猜的一樣.<br>
                除此之外的其他時候，我覺得不太需要指定 [--key-slot] ，隨便給一個存在的密碼都可以，系統會自己去比對所有 slot 的密碼.</p>
                
        </div>
    <p class="pch pch-cls">[--key-slot].</p>
    
    <p class="pch">[luksChangeKey].</p>
        <p><a href="./E160313_193957.html#E160313_213416">+ 要指定 keyslot.</a><br>
        + <span class="gh_2">可以</span>在 decrypt 的狀態下改密碼.<br>
        + 如果打錯給該 slot 的密碼, <span class="gh_2">不會</span>有錯誤訊息, 打正確了才會問你說新密碼要設什麼.</p>
    
    <p class="pch">偵測 decrypt.</p>
        <p>如果不知道目前到底有沒有 luksdevice 被 decrypt ，用這些方法都可以知道：<br>
        {{ [cryptsetup] . [luksClose] }} 然後 [Tab] 2 下，讓 bash completion 告訴我，如果沒有，就會跳不出任何東西.<br>
        {{ [ll] . [/dev/mapper] }}.<br>
        [lsblk] 看看 後面的 mount point.</p>
    
    <p class="pch">偵測 slot.</p>
        <p>如果要看某 luksdevice 有幾個是已經設定過 passphrass 的 slot，有幾個是空的 slot，可以 {{ [cryptsetup] . [luksDump] . &lt;loops-device&gt; }}.</p>
    
    <p class="pch">查看 "mapping-alias" 資訊.</p>
        <p>在 decrypt 狀態下，才可以用 {{ [cryptsetup] . [status] . &lt;mapping-alias&gt; }} 看 "mapping alias" 的資訊.</p>
    
    <p class="pch">password steaming.</p>
        <p>"[... && read -rs -p 'Enter passwd:' passwD && echo $passwD | cryptsetup luksOpen &lt;loop device&gt; &lt;mapping alias> - && ...]"<br>
        The key point is the [-] character, which input the stream from [echo #passwD] . And the [-s] keep [read] not to show the typing password on the screen.</p>
    
    <p class="pch">Resize, enlarge.</p>
        <p>+ <a href="http://unix.stackexchange.com/questions/41091/how-can-i-shrink-a-luks-partition-what-does-cryptsetup-resize-do">How can I shrink a LUKS partition, what does `cryptsetup resize` do?</a><br>
        + <a href="http://ubuntuforums.org/showthread.php?t=726724">How to Resize a LUKS Encrypted File System.</a></p>
    
</div>

</body>
</html>